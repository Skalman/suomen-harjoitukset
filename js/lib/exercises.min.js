/* Exercises 0.1.0 (built 2013-05-02) | (c) 2013 Dan Wolff | License: GPLv3 | github.com/Skalman/exercises */
(function(e,r,t,s,n,i){"use strict";function c(e,r){return function(t){if(t){if(!r[t]||!r[t][e])throw Error("Can't "+t+" from "+e);e=r[t][e]}return e}}function a(e,r){if(u===i)throw Error("Expected the variable 'precompiled_templates' to be available.");if(!u[e])throw Error("No template with ID '"+e+"' found.");return u[e](r)}function o(e){return this instanceof o?(e?e._is_i18n?t.extend(this,e):t.extend(this,this.defaults(),e):t.extend(this,this.defaults()),i):new o(e)}var u=function(){return t.extend({"exercises-practice":function(e){var r="",s=t.escape,n=e.i18n;return r+='<form><div><div class="instructions-w"><div class="instructions"></div></div><div class="progress"><span class="progress-current"></span> / <span class="progress-total"></span></div></div><div class="input"><div class="question-w"><div class="question"></div></div><div class="answer"><input /><div class="result"><button class="check" type="submit">'+s(n("check"))+'</button><div class="correct">✓ <span class="correct-text">'+s(n("answer_correct"))+'</span></div><div class="incorrect">✗ <span class="incorrect-text">'+s(n("answer_incorrect"))+'</span></div></div></div><div class="clearfix"></div></div><div class="loading">'+s(n("loading"))+'</div><div class="correct-answer-w-w"><div class="correct-answer-w"><span class="correct-answer-text"></span>\n<span class="correct-answer"></span></div></div><div class="continue-w"><button class="continue" type="submit">'+s(n("continue"))+"</button></div></form>"},"exercises-result":function(e){var r,s="",n=t.escape,i=e.i18n,c=e.exercises;return s+='<p class="main-result">'+n(i("main_result",e.correct_count,c.length))+"</p><p>",e.incorrect_count&&(s+='<button class="redo-incorrect">↻ '+n(i("redo_incorrect",e.incorrect_count))+"</button>"),s+='\n<button class="quit">× '+n(i("quit"))+'</button>\n<button class="redo-all"><span>↻</span> '+n(i("redo_all"))+'</button></p><ul><li><div class="question"><h3>'+n(i("questions"))+'\n<span class="total">('+(null==(r=c.length)?"":r)+')</span></h3></div><div class="user-answer"><h3>'+n(i("your_answers"))+'\n<span class="total-correct">('+n(i("total_correct",e.correct_count))+")</span></h3></div></li>\n",c.each(function(e){s+='\n<li class="'+(null==(r=e.get("user_answer_is_correct")?"correct":"incorrect")?"":r)+'"><div class="question"><span class="base-form">'+n(e.get("question"))+'</span> <br />\n<span class="real-answer">'+n(e.get("answer").join(", "))+'</span></div><div class="user-answer"><span>'+n(e.get("user_answer"))+"</span></div></li>\n"}),s+="</ul>"}},e.precompiled_templates)}(),l=e.console||{log:function(){},error:function(){}},_=function(){function e(e){return"\\"+s[e]}function r(r){return"'"+r.replace(t,e)+"'"}var t=/\\|'|\r|\n|\t|\u2028|\u2029/g,s={"'":"'","\\":"\\","\r":"r","\n":"n","	":"t","\u2028":"u2028","\u2029":"u2029"};return r}();o.prototype={defaults:function(){return{_messages:{},lang:"en",_langs:{en:{plural:o.plural_rules[1]},es:{plural:o.plural_rules[1]},fi:{plural:o.plural_rules[1]},fr:{plural:o.plural_rules[2]},sv:{plural:o.plural_rules[1]}},_is_i18n:!0}},messages:function(e,r,s){var n=this;return r===i?t.each(e,function(e,r){n._messages[r]=e}):s===i?n._messages[e]=r:n._messages[e][r]=s,this},get_func:function(){var e=this;return function(){return e.get.apply(e,arguments)}},get:function(e){var r,s,n,i;if(t.isString(e)?(s=e,r=this.lang,n=Array.prototype.slice.call(arguments,1)):(s=e.message_id,r=e.lang||this.lang,n=e.args||[],i=e.get_compiled),"qqq"===r)return"%"+s+"("+n.join(", ")+")"+"%";var c=this._messages[r],a=c&&c[s];return a?(t.isFunction(a)||(a=c[s]=this._compile(a)),i?a:a({args:n,lang:this._langs[r]||this._langs.en})):(c?"en"!==r?(l.error("i18n: Message '%s' for language code '%s' not found. Try 'en'...",s,r),r="en"):(l.error("i18n: Message '%s' for language code 'en' not found",s),r="qqq"):r===this.lang&&"en"!==r?(l.error("i18n: No messages with language code '%s' found. Switching to 'en'",r),r=this.lang="en"):(l.error("i18n: No messages with language code 'en' found"),r="qqq"),this.get({message_id:s,lang:r,args:n}))},_re_arg:/\$(\d+)/g,_re_plural:/\{\{PLURAL:([^\|]+)\|(.+?)\}\}/g,_re_escaper:/\\|'|\r|\n|\t|\u2028|\u2029/g,_compile:function(e){var r=this._re_arg;return e=e.replace(this._re_plural,function(e,s,n){return s=s.replace(r,function(e,r){return"env.args["+(r-1)+"]"}),n=t.map(n.split("|"),_).join(","),n&&(n=", "+n),"<% print(env.lang.plural("+s+n+")) %>"}).replace(r,function(e,r){return"<%=env.args["+(r-1)+"]%>"}),t.template(e,null,{variable:"env"})},clone:function(){return new o(this)}},o.plural_rules=[function(e,r){return r},function(e,r,t){return 1===e?r:t},function(e,r,t){return 0===e||1===e?r:t}];var h=n.Model.extend({defaults:function(){return{question:i,answer:i,user_answer:i,user_answer_is_correct:i,instructions:i,picture:i,background:i}},constructor:function(e,r){e&&t.isString(e.answer)&&(e.answer=[e.answer]),n.Model.call(this,e,r)},clone_reset:function(){return new h(t.omit(this.attributes,"user_answer","user_answer_is_correct"))},get_answer:function(){function e(e){return t.isArray(e)||(e=[e]),s.set("answer",e),e}var s=this,n=s.get("answer"),i=s._get_answer_promise;return i?i:(t.isFunction(n)&&(n=n(s),r.isPromise(n)||(n=e(n))),i=r.isPromise(n)?n.then(e):r.when(t.isArray(n)?n:[n]),s._get_answer_promise=i,i)},check_answer:function(e){l.log("exercise: checking %s",e);var r=this;return r.set("user_answer",e),r.get_answer().then(function(n){e=s.trim(e.toLowerCase());var c,a=t.find(n,function(r){return(r+"").toLowerCase()===e});return c=a!==i,r.set("user_answer_is_correct",c),c})},check_and_get_answer:function(e){var r=this;return this.check_answer(e).then(function(e){return{is_correct:e,answer:r.get("answer")}})}}),d=n.Collection.extend({model:h,defaults:function(){return{instructions:i,picture:i,background:i,random_order:!0}},constructor:function(e,r){var s,i=this.defaults(),c=t.keys(i);e&&!t.isArray(e)&&(s=e,e=s.exercises),t.extend(this,i,s&&s.based_on&&t.pick(s.based_on,c),s&&t.pick(s,c)),n.Collection.call(this,e,r)},user_has_answered_all:function(){return!this.findWhere({user_answer:i})},next_exercise_index:function(){var e;return this.find(function(r,t){return r.get("user_answer")===i?(e=t,!0):i}),e},next_exercise_and_preload:function(){throw Error("Not implemented yet. I am lazy")}}),w=n.View.extend({events:{submit:"submit"},_sm_events:{render:{none:"unanswered"},answer:{unanswered:"answered"},check_answer:{answered:"checked_answer"},next:{checked_answer:"none"}},initialize:function(e){l.log("practice: init");var r=e.$parent,t=r.find(".exercises-practice[lang="+e.i18n.lang+"]");t.length||(t=s("<div>",{"class":"exercises-practice",lang:e.i18n.lang,html:a("exercises-practice",{i18n:e.i18n.get_func()})}).appendTo(r)),this.setElement(t),this.exercises=e.exercises,this.sm=new c("none",this._sm_events),this.i18n=e.i18n,this.$instructions=this.$(".instructions"),this.$progress_current=this.$(".progress-current"),this.$progress_total=this.$(".progress-total"),this.$question=this.$(".question"),this.$input=this.$("input"),this.$correct_answer=this.$(".correct-answer"),this.$correct_answer_text=this.$(".correct-answer-text"),this.$continue=this.$(".continue"),this.$el.show(),this.render()},render:function(){var e=this.exercises,r=e.next_exercise_index(),t=e.at(r);return this.current_exercise=r,r===i?(this.complete(),i):(this.sm("render"),this._html(this.$instructions,t.get("instructions")||e.instructions),this.$progress_current.text(r+1),this.$progress_total.text(e.length),this._html(this.$question,t.get("question")),this.$input.val("").focus(),t.get_answer(),this)},_html:function(e,r){r||(r="[no text given]"),r.html?e.html(r.html):e.text(r.text||r)},submit:function(e){e.preventDefault(),"unanswered"===this.sm()?this.check_answer(this.$input.val()):"checked_answer"===this.sm()&&this.next()},check_answer:function(e){if(e){var r=this;r.sm("answer"),r.$el.addClass("answered"),r.$input.attr("readonly",""),r.exercises.at(r.current_exercise).check_and_get_answer(e).then(function(e){r.sm("check_answer"),r.$el.addClass("retrieved-answer").addClass(e.is_correct?"answer-correct":"answer-incorrect");var n=s.isArray(e.answer)?e.answer:[e.answer];r.$correct_answer_text.text(r.i18n.get("correct_answer_text",n.length));var i=t.map(n,function(e){return[s("<span>",e.html?{html:e.html}:{text:e+""}),", "]});i=t.flatten(i),i.pop(),r.$correct_answer.append(i),r.$continue.focus()})}},next:function(){this.sm("next"),this.$input.removeAttr("readonly"),this.$el.removeClass("answered retrieved-answer answer-correct answer-incorrect"),this.$correct_answer.empty(),this.render()},complete:function(){this.$el.hide(),this.trigger("complete")}}),g=n.View.extend({events:{"click .redo-incorrect":"redo_incorrect","click .quit":"quit","click .redo-all":"redo_all"},initialize:function(e){l.log("results: init");var r=e.$parent,t=r.find(".exercises-result");t.length||(t=s("<div>",{"class":"exercises-result",lang:e.i18n.lang}).appendTo(r)),this.setElement(t),this.i18n=e.i18n,this.exercises=e.exercises,this.render()},render:function(){var e=this.exercises,r=e.where({user_answer_is_correct:!0}).length;this.$el.html(a("exercises-result",{i18n:this.i18n.get_func(),exercises:e,correct_count:r,incorrect_count:e.length-r})),this.$el.show(),this.$("button:first:visible").focus()},quit:function(){this.trigger("close").reset()},redo:function(e){var r,s=this.exercises;r=e?s.where(e):s.slice(0),r=t.chain(r).invoke("clone_reset"),s.random_order&&(r=r.shuffle()),r=r.value(),this.trigger("redo",r).reset()},redo_incorrect:function(){this.redo({user_answer_is_correct:!1})},redo_all:function(){this.redo()},reset:function(){return this.undelegateEvents(),this.$el.text(""),this}}),p=n.View.extend({initialize:function(e){l.log("app: init"),this.setElement(e.elem),this.Practice_view=e.Practice_view||w,this.Result_view=e.Result_view||g,this.i18n=p.i18n.clone(),e.lang&&(this.i18n.lang=e.lang),this.exercises=e.exercises,this.render(e.exercises)},render:function(){var e=this.exercises;return e.user_has_answered_all()?this.render_results():this.render_practice()},render_practice:function(){var e=new this.Practice_view({$parent:this.$el,exercises:this.exercises,i18n:this.i18n});return this.listenToOnce(e,"complete",this.render_results),this},render_results:function(){var e=new this.Result_view({$parent:this.$el,exercises:this.exercises,i18n:this.i18n});return this.listenToOnce(e,"close",t.bind(this.trigger,this,"complete")).listenToOnce(e,"redo",this.redo),this},redo:function(e){this.exercises=new d({exercises:e,based_on:this.exercises}),this.render()}});p.i18n=(new o).messages("en",{check:"Check answer","continue":"Continue ❯",answer_correct:"Correct",answer_incorrect:"Incorrect",correct_answer_text:"Correct {{PLURAL:$1|answer|answers}}:",loading:"Loading...",main_result:"$1 of $2 {{PLURAL:$1|answer|answers}} correct",redo_incorrect:"Redo incorrect",quit:"Quit",redo_all:"Redo all",questions:"Questions",your_answers:"Your answers",total_correct:"$1 correct"}),p.i18n.messages("es",{check:"Comprueba","continue":"Continúa ❯",answer_correct:"Correcto",answer_incorrect:"Incorrecto",correct_answer_text:"Correct {{PLURAL:$1|answer|answers}}:",loading:"Se está cargando...",main_result:"$1 / $2 de {{PLURAL:$1|???|respuestas son correctas}}",redo_incorrect:"Redo incorrect",quit:"Quit",redo_all:"Redo all",questions:"Questions",your_answers:"Your answers",total_correct:"$1 correct"}),p.i18n.messages("fi",{check:"Tarkista","continue":"Jatka ❯",answer_correct:"Oikein",answer_incorrect:"Väärin",correct_answer_text:"{{PLURAL:$1|Oikea vastaus|Oikeat vastaukset}}:",loading:"Ladataan...",main_result:"$1 / $2 {{PLURAL:$1|vastaus|vastausta}} oikein",redo_incorrect:"Tee väärin {{PLURAL:$1|mennyt harjoitus|menneet harjoitukset}} uudestaan",quit:"Lopeta",redo_all:"Tee kaikki uudestaan",questions:"Kysymykset",your_answers:"Vastauksisi",total_correct:"$1 oikein"}),p.i18n.messages("sv",{check:"Kontrollera","continue":"Fortsätt ❯",answer_correct:"Rätt",answer_incorrect:"Fel",correct_answer_text:"{{PLURAL:$1|Rätt|Rätta}} svar:",loading:"Laddar...",main_result:"$1 / $2 svar {{PLURAL:$1|korrekt|korrekta}}",redo_incorrect:"Gör om {{PLURAL:$1|den övning|de övningar}} som gick fel",quit:"Avsluta",redo_all:"Gör om alla",questions:"Frågor",your_answers:"Dina svar",total_correct:"$1 {{PLURAL:$1|korrekt|korrekta}}"}),e.Exercise=h,e.Exercise_list=d,e.Practice_view=w,e.Result_view=g,e.App_view=p})(this,Q,_,jQuery,Backbone);